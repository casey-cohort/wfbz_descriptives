---
title: "WFBZ Summaries - FEMA"
toc: true
execute:
  echo: false
  warning: false
  message: false
---

```{r packages}
library(tidyverse)
library(sf)
library(patchwork)
library(gt)
library(glue)
library(showtext)
library(tidycensus)
library(ggh4x)
library(lemon)
library(tigris)

options(scipen = 9999)
set.seed(708)
```

```{r theme}
# Set Font Arial
showtext_auto()
font_add("Arial", regular = "LiberationSans-Regular.ttf")
base_size = 16
theme_set(
  ggplot2::theme_minimal(
    base_family = 'Arial',
    base_size = base_size
  ) +
    ggplot2::theme(
      legend.background = element_blank(),
      legend.key = element_blank(),
      panel.background = element_blank(),
      panel.border = element_blank(),
      strip.background = element_blank(),
      plot.background = element_blank(),
      axis.line = element_blank(),
      panel.grid = element_blank(),
      plot.title = element_text(size = base_size + 14L),
      plot.subtitle = element_text(size = base_size + 8L),
      #panel.border = element_rect(color = "grey25", fill = NA, size = .25),
      #plot.title = element_text(size = 18),
      axis.text.x = element_text(angle = 90, vjust = +.5),
      axis.ticks = element_line(),
      panel.spacing = unit(0, 'in')
      #axis.title.y = element_blank()
    )
)
```

```{r data}
#| echo: false
#| message: false
if (!file.exists('data/raw/wfbz_disasters_2000-2025.geojson')) {
  stop(
    "Manually download data set from https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/DWILBW and unzip to data/raw."
  )
}

unzip_url <- function(url, dst) {
  download.file(
    url = url,
    destfile = t <- tempfile(fileext = ".zip")
  )
  unzip(t, overwrite = TRUE, exdir = dst)
  unlink(t, recursive = TRUE)
  dst
}

wfbz <- read_sf("data/raw/wfbz_disasters_2000-2025.geojson") %>%
  filter(!st_is_empty(geometry))
wfbz <- wfbz %>%
  filter(!str_detect(wildfire_complex_names, '(FLOOD$|FLOOD 2013$)')) # remove some colorado floods that snuck in

states_sf <- tigris::states(progress_bar = FALSE)

if (!file.exists('data/raw/tiger_counties.geojson')) {
  counties_pop <- get_decennial(
    geography = "county",
    variables = "P1_001N", # Total population variable in 2020 Census
    year = 2020,
    geometry = TRUE,
    output = "wide",
    progress_bar = FALSE
  ) %>%
    rename(population = P1_001N) %>%
    select(population, geometry)
  write_sf(counties_pop, 'data/raw/tiger_counties.geojson')
} else {
  counties_pop <- 'data/raw/tiger_counties.geojson'
}

if (!file.exists('data/raw/tiger_states.geojson')) {
  states_pop <- get_decennial(
    geography = "state",
    variables = "P1_001N", # Total population variable in 2020 Census
    year = 2020,
    geometry = TRUE,
    output = "wide",
    progress_bar = FALSE
  ) %>%
    rename(population = P1_001N) %>%
    select(NAME, population, geometry) %>%
    left_join(
      tidycensus::fips_codes %>%
        select(state_abb = state, NAME = state_name) %>%
        distinct()
    ) %>%
    rename(state_name = NAME)
  write_sf(states_pop, 'data/raw/tiger_states.geojson')
} else {
  states_pop <- read_sf('data/raw/tiger_states.geojson')
}

# Order regions consistently
REGION_ORDER <- tibble(
  usfs_region = c(
    "California",
    "Southern",
    "Alaska",
    "Southern Rockies",
    "Southwestern",
    "Northern Rockies",
    "Intermountain",
    "Pacific Northwest",
    "Eastern",
    "Hawaii"
  ),
  plot_order = 10:1
)
# Palette
region_colors <- c(khroma::color('light', reverse = FALSE)(9), '#ac87cc')
region_colors[region_colors == '#dddddd'] <- '#757575' # lil darker
attr(region_colors, "missing") <- NA
names(region_colors) <- sort(REGION_ORDER$usfs_region)


if (!file.exists('data/processed/regions.geojson')) {
  regions <- read_sf(unzip_url(
    "https://data.fs.usda.gov/geodata/edw/edw_resources/shp/S_USA.AdministrativeRegion.zip",
    dst = tempfile(fileext = ".shp")
  )) %>%
    select(usfs_region = REGIONNAME) %>%
    mutate(usfs_region = str_replace(usfs_region, " Region", ""))

  regions <- bind_rows(
    regions,
    st_filter(
      regions %>%
        filter(usfs_region == 'Pacific Southwest') %>%
        st_cast("POLYGON"),
      states_sf %>% filter(STUSPS == 'HI')
    ) %>%
      group_by(usfs_region) %>%
      summarize(geometry = st_combine(geometry)) %>%
      mutate(usfs_region = 'Hawaii'),
    st_filter(
      regions %>%
        filter(usfs_region == 'Pacific Southwest') %>%
        st_cast("POLYGON"),
      states_sf %>% filter(STUSPS == 'CA')
    ) %>%
      group_by(usfs_region) %>%
      summarize(geometry = st_combine(geometry)) %>%
      mutate(usfs_region = 'California')
  ) %>%
    filter(usfs_region != 'Pacific Southwest') %>%
    mutate(
      usfs_region = if_else(
        usfs_region == 'Northern',
        'Northern Rockies',
        usfs_region
      )
    ) %>%
    mutate(
      usfs_region = if_else(
        usfs_region == 'Rocky Mountain',
        'Southern Rockies',
        usfs_region
      )
    )

  regions$usfs_region_pop <- aggregate(
    st_centroid(counties_pop),
    regions,
    FUN = sum
  )$population # centroid more or less ensures counties only end up in one region

  write_sf(regions, 'data/processed/regions.geojson')
} else {
  regions <- read_sf('data/processed/regions.geojson')
}
```

```{r}
# Find Nearest Region
wfbz_region <- regions$usfs_region[st_nearest_feature(
  wfbz,
  regions,
  pairwise = TRUE
)]
wfbz_region_area <- as.numeric(
  st_area(regions)[st_nearest_feature(wfbz, regions, pairwise = TRUE)] /
    1000 /
    1000
)
wfbz_region_pop <- regions$usfs_region_pop[st_nearest_feature(
  wfbz,
  regions,
  pairwise = TRUE
)]

by_state <- wfbz %>%
  st_drop_geometry() %>%
  mutate(
    state_abb = str_split(wildfire_states, '\\|')
  ) %>%
  unnest(state_abb) %>%
  left_join(st_drop_geometry(states_pop)) %>%
  left_join(
    st_centroid(states_sf, of_largest_polygon = TRUE) %>% st_join(regions) %>% st_drop_geometry() %>% select(STUSPS, usfs_region),
    by = join_by(state_abb == STUSPS)
  ) %>%
  filter(wildfire_community_intersect) %>%
  group_by(usfs_region, state_abb, state_name) %>%
  summarize(
    `Events` = n(),
    `Fatalities` = sum(wildfire_max_civil_fatalities, na.rm = TRUE),
    `Fatalities per 100K` = 100000 *
      sum(wildfire_max_civil_fatalities / population, na.rm = TRUE),
    `Structures Destroyed` = sum(wildfire_struct_destroyed, na.rm = TRUE),
    `FEMA Declarations` = sum(wildfire_fema_dec, na.rm = TRUE),
    `FEMA Declaration Percent` = `FEMA Declarations` / `Events`,
    `Burned Area` = sum(wildfire_area, na.rm = TRUE),
    `WUI-Intermix` = sum(str_detect(wildfire_wui, 'intermix'), na.rm = TRUE),
    `WUI-Interface` = sum(str_detect(wildfire_wui, 'interface'), na.rm = TRUE),
    .groups = 'drop'
  )
by_state <- by_state %>%
  arrange(desc(`FEMA Declaration Percent`), state_abb) %>%
  mutate(
    state_abb = factor(row_number(), levels = row_number(), labels = state_abb),
    state_name = factor(
      row_number(),
      levels = row_number(),
      labels = state_name
    )
  )
```

### Fema Declaration Likelihood by State

```{r, fig.height = 9, fig.width = 9}
ggplot() +
  geom_col(
    data = by_state,
    aes(y = state_name, x = `FEMA Declaration Percent`),
    fill =  khroma::color('light', reverse = FALSE)(1),
    color = 'white',
  ) +
  geom_text(
    data = by_state,
    aes(
      y = state_name,
      x = `FEMA Declaration Percent`,
      label = paste0(
        case_when(
          between(`FEMA Declaration Percent`, .001, .02) ~ paste0(
            sprintf('%.1f', 100 * `FEMA Declaration Percent`),
            '%'
          ),
          `FEMA Declaration Percent` < .001 ~ '',
          TRUE ~ paste0(sprintf('%.0f', 100 * `FEMA Declaration Percent`), '%'),
        ),
        if_else(
          `FEMA Declarations` == 0,
          '0',
          glue(' ({`FEMA Declarations`})')
        )
      ),
      hjust = -.1
    ),
    color = 'grey10'
  ) +
  scale_x_continuous(
    labels = scales::percent,
    name = 'Events declared disaster',
    expand = c(0, 0, 0, .17)
  ) +
  scale_y_discrete(name = '', limits = rev, expand = c(.01, .01)) +
  theme(
    panel.margin = unit(0, 'cm'),
    axis.ticks = element_blank(),
    axis.text.y = element_text(hjust = 1),
    panel.grid.major.x = element_line(linewidth = .25, color = 'grey25'),
    panel.grid.minor.x = element_line(linewidth = .25, color = 'grey75')
  )
```

### Variables vs. FEMA Declarations

```{r, fig.height = 30, fig.width = 8}
by_state_long <- by_state %>%
  select(-`FEMA Declaration Percent`) %>% 
  pivot_longer(-c(usfs_region, state_abb, state_name, `FEMA Declarations`)) 

plotme <- function(by_state_long, name){
  ggplot(by_state_long) +
    #geom_abline(slope = 1, intercept = 0, linetype = 'dashed', color = 'grey75') +
    geom_point(aes(x = value, y = `FEMA Declarations`, color = usfs_region)) +
    ggrepel::geom_label_repel(
      aes(x = value, y = `FEMA Declarations`, label = state_abb, fill = usfs_region),
      max.overlaps = 5
    ) +
    scale_x_continuous(name = name, labels = scales::comma) +
    scale_y_continuous(labels = scales::comma) +
    scale_fill_manual(
      values = region_colors
    ) +
    scale_color_manual(
      values = region_colors
    ) + 
    #facet_wrap(~name, ncol = 1, scales = 'free', strip.position = 'bottom') +
    theme(
      plot.margin = margin(r = 25, l = 25, unit = "pt"),
      panel.grid.major = element_line(linewidth = .25, color = 'grey75'), 
      axis.ticks = element_blank(),
      legend.position = 'bottom'#, 
      #panel.spacing.y = unit(100, 'pt')
    ) + 
    guides(
      color = 'none',
      fill = guide_legend(ncol = 2, title = NULL, override.aes = list(label = '  '))
    )
}


scatters <- by_state_long %>%
  group_by(name) %>%
  nest() %>%
  mutate(
    p_natural = map(data, plotme, name = name),
    p_log = map(
      p_natural, 
      ~ .x +  
        scale_x_continuous(name = name, labels = scales::comma, transform = 'pseudo_log') +
        scale_y_continuous(labels = scales::comma, transform = 'pseudo_log') 
    )
  )

# Create text grobs for headers
header_natural <- wrap_elements(grid::textGrob("Natural scale", gp = grid::gpar(fontsize = 14, fontface = "bold")))
header_log <- wrap_elements(grid::textGrob("Log scale", gp = grid::gpar(fontsize = 14, fontface = "bold")))

# Put all plots together with headers
n_plots <- nrow(scatters)
all_plots <- c(
  list(header_natural), scatters$p_natural,
  list(header_log), scatters$p_log
)

wrap_plots(
  all_plots, 
  ncol = 2, 
  byrow = FALSE, 
  heights = c(0.1, rep(1, n_plots)), 
  guides = 'collect'
) & 
  theme(legend.position = 'bottom', plot.margin = unit(c(0, 5, 50, 5), 'pt'))

# 
# wrap_plots(
#   wrap_plots(scatters$p_natural, ncol = 1, guides = 'collect'),
#   wrap_plots(scatters$p_log, ncol = 1, guides = 'collect'),
#   ncol = 2,
#   guides = 'collect'
# )# +
#   plot_annotation(theme = theme(legend.position = 'bottom'))
```

_Note: to show y axis label at each plot will require custom coding -- need to jitter y axis values
or else create each plot without facet_

```{r}
hexgrid <- st_make_grid(states_pop, square = FALSE, n = c(500, 500)) %>%
  st_as_sf() %>%
  mutate(hexid = row_number()) %>%
  st_filter(states_pop)

hex_summary <- hexgrid %>%
  st_join(wfbz, left = FALSE) %>%
  group_by(hexid) %>%
  summarize(
    `Events` = n(),
    `Fatalities` = sum(wildfire_max_civil_fatalities, na.rm = TRUE),
    `Structures Destroyed` = sum(wildfire_struct_destroyed, na.rm = TRUE),
    `FEMA Declarations` = sum(wildfire_fema_dec, na.rm = TRUE),
    `Burned Area` = sum(wildfire_area, na.rm = TRUE),
    `WUI-Intermix` = sum(str_detect(wildfire_wui, 'intermix'), na.rm = TRUE),
    `WUI-Interface` = sum(str_detect(wildfire_wui, 'interface'), na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  st_shift_longitude()

theme_update(
  axis.ticks.x = element_blank(),
  axis.ticks.y = element_blank(),
  axis.text.x = element_blank(),
  axis.text.y = element_blank(),
  axis.line = element_blank()
)
```

### Geographic Distribution (all years)

Events

```{r}
ggplot() +
  geom_sf(
    data = shift_geometry(hex_summary),
    aes(fill = Events),
    color = NA
  ) +
  geom_sf(data = shift_geometry(states_pop), fill = NA, color = 'grey25') +
  scale_fill_distiller(palette = 'Spectral', name = '')

```

FEMA Declarations

```{r}
ggplot() +
  geom_sf(
    data = shift_geometry(hex_summary),
    aes(fill = `FEMA Declarations`),
    color = NA
  ) +
  geom_sf(data = shift_geometry(states_pop), fill = NA, color = 'grey25') +
  scale_fill_distiller(palette = 'Spectral', name = '')

```

Declarations per Event

*How to disentangle that FEMA Declarations makes an event?*

```{r}
ggplot() +
  geom_sf(
    data = shift_geometry(hex_summary),
    aes(fill = `FEMA Declarations` / Events),
    color = NA
  ) +
  geom_sf(data = shift_geometry(states_pop), fill = NA, color = 'grey25') +
  scale_fill_distiller(palette = 'Spectral', name = '', labels = scales::percent)
```

Declarations per Event (Scale Shifted)

```{r}
#| include: false
ggplot() +
  geom_sf(
    data = shift_geometry(hex_summary),
    aes(fill = `FEMA Declarations` / Events),
    color = NA
  ) +
  geom_sf(data = shift_geometry(states_pop), fill = NA, color = 'grey25') +
  scale_fill_distiller(
    palette = 'Spectral',
    name = '',
    values = c(0, scales::breaks_log()(c(.0001, 1)))
  )
```
